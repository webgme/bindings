/*eslint-env node, mocha*/
/**
 * Generated by PluginGenerator 2.20.5 from webgme on Tue Mar 09 2021 13:00:55 GMT-0600 (Central Standard Time).
 */

describe('PythonBindingsWait', function () {
    var testFixture = require('../../globals'),
        gmeConfig = testFixture.getGmeConfig(),
        expect = testFixture.expect,
        logger = testFixture.logger.fork('PythonBindingsWait'),
        PluginCliManager = testFixture.WebGME.PluginCliManager,
        projectName = 'testProject',
        pluginName = 'PythonBindingsWait',
        project,
        gmeAuth,
        storage,
        commitHash;

    before(function (done) {
        this.timeout(10000);
        testFixture.clearDBAndGetGMEAuth(gmeConfig, projectName)
            .then(function (gmeAuth_) {
                gmeAuth = gmeAuth_;
                // This uses in memory storage. Use testFixture.getMongoStorage to persist test to database.
                storage = testFixture.getMemoryStorage(logger, gmeConfig, gmeAuth);
                return storage.openDatabase();
            })
            .then(function () {
                var importParam = {
                    projectSeed: testFixture.path.join(testFixture.SEED_DIR, 'EmptyProject.webgmex'),
                    projectName: projectName,
                    branchName: 'master',
                    logger: logger,
                    gmeConfig: gmeConfig
                };

                return testFixture.importProject(storage, importParam);
            })
            .then(function (importResult) {
                project = importResult.project;
                commitHash = importResult.commitHash;
                return project.createBranch('test', commitHash);
            })
            .nodeify(done);
    });

    after(function (done) {
        storage.closeDatabase()
            .then(function () {
                return gmeAuth.unload();
            })
            .nodeify(done);
    });

    it('should run plugin and update the branch', function (done) {
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: true
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            };

        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            project.getBranchHash('test')
                .then(function (branchHash) {
                    expect(branchHash).to.not.equal(commitHash);
                    commitHash = branchHash;
                })
                .nodeify(done);
        });
    });

    it('should run plugin and not update the branch', function (done) {
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: false
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            };

        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            project.getBranchHash('test')
                .then(function (branchHash) {
                    expect(branchHash).to.equal(commitHash);
                })
                .nodeify(done);
        });
    });

    it('should run plugin, not update the branch, and wait', function (done) {
        this.timeout(5000);
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: false,
                wait: 2
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            },
            waited = false;

        setTimeout(()=> {
            waited = true;
        }, 2000);
        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            project.getBranchHash('test')
                .then(function (branchHash) {
                    expect(branchHash).to.equal(commitHash);
                    expect(waited).to.equal(true);
                })
                .nodeify(done);
        });
    });

    it('should run multiple instances of the plugin', function (done) {
        this.timeout(5000);
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: false,
                wait: 2
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            },
            shortFinished = false;

        
        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
                expect(shortFinished).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }
            done(null);

        });

        const secondConfig = JSON.parse(JSON.stringify(pluginConfig));
        secondConfig.wait = 0;
        manager.executePlugin(pluginName, secondConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            shortFinished = true;
        });

    });

    it('should run 3 instances of the plugin that should end in order', function (done) {
        this.timeout(5000);
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: false,
                wait: 4
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            },
            shortFinished = false,
            longFinished = false;

        
        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
                expect(shortFinished).to.equal(true);
                expect(longFinished).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }
            done(null);

        });

        const secondConfig = JSON.parse(JSON.stringify(pluginConfig));
        secondConfig.wait = 2;
        manager.executePlugin(pluginName, secondConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
                expect(shortFinished).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            longFinished = true;
        });

        const thirdConfig = JSON.parse(JSON.stringify(pluginConfig));
        thirdConfig.wait = 0;
        manager.executePlugin(pluginName, thirdConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            shortFinished = true;
        });

    });

    it('should run multiple instances of the plugin and the second fork', function (done) {
        this.timeout(5000);
        var manager = new PluginCliManager(null, logger, gmeConfig),
            pluginConfig = {
                modify: true,
                wait: 2
            },
            context = {
                project: project,
                commitHash: commitHash,
                branchName: 'test',
                activeNode: '/1',
            },
            shortFinished = false,
            finishedSoFar = 0;

        function finished() {
            if (++finishedSoFar === 2) {
                done(null);
            }
        }
        manager.executePlugin(pluginName, pluginConfig, context, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
                expect(shortFinished).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }
            
            // this should be the forked plugin
            project.getBranchHash('test')
                .then(function (branchHash) {
                    expect(branchHash).to.equal(commitHash);
                    commitHash = branchHash;
                })
                .then(finished)
                .catch(done);

        });

        const secondConfig = JSON.parse(JSON.stringify(pluginConfig));
        const secondContext = {
            project: project,
            commitHash: commitHash,
            branchName: 'test',
            activeNode: '',
        };
        secondConfig.wait = 0;
        manager.executePlugin(pluginName, secondConfig, secondContext, function (err, pluginResult) {
            try {
                expect(err).to.equal(null);
                expect(typeof pluginResult).to.equal('object');
                expect(pluginResult.success).to.equal(true);
            } catch (e) {
                done(e);
                return;
            }

            shortFinished = true;

            project.getBranchHash('test')
                .then(function (branchHash) {
                    expect(branchHash).to.not.equal(commitHash);
                    commitHash = branchHash;
                })
                .then(finished)
                .catch(done);
        });

    });
});
